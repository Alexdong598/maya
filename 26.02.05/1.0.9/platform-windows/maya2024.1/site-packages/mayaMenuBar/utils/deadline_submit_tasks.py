import os
import subprocess
import tempfile
import logging
import sys

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class DeadlineSubmitter:
    def __init__(self, deadline_bin=None):
        self.deadline_bin = deadline_bin or self._find_deadline_bin()
        if self.deadline_bin and os.path.exists(self.deadline_bin):
            logger.info(f"Initialized Deadline Submitter using: {self.deadline_bin}")
        else:
            self.deadline_bin = None

    @staticmethod
    def _find_deadline_bin():
        deadline_8_path = r"C:\Program Files\Thinkbox\Deadline8\bin\deadlinecommand.exe"
        env_path = os.environ.get("DEADLINE_PATH", "")
        if os.path.exists(deadline_8_path):
            return deadline_8_path
        if env_path and "Deadline" in env_path:
            candidate = os.path.join(env_path, "deadlinecommand.exe")
            if os.path.exists(candidate):
                return candidate
        return None

    def submit(self, job_info: dict, plugin_info: dict):
        if not self.deadline_bin:
            self.deadline_bin = self._find_deadline_bin()

        if not self.deadline_bin or not os.path.exists(self.deadline_bin):
            raise FileNotFoundError(
                "Deadline executable not found.\n"
                f"Checked path: C:\\Program Files\\Thinkbox\\Deadline8\\bin\\deadlinecommand.exe\n"
                "Please ensure the Deadline Client is installed."
            )
        
        env_index = 0
        while f"EnvironmentKeyValue{env_index}" in job_info:
            env_index += 1

        count_added = 0

        ALLOWED_HOUDINI_KEYS = {
            # Standard System Paths
            "PATH",
            "PYTHONPATH",
            
            # Houdini Core Paths
            "HOUDINI_PATH",
            "HOUDINI_OTLSCAN_PATH",
            "HOUDINI_SCRIPT_PATH",
            "HOUDINI_TOOLBAR_PATH",
            "HOUDINI_MENU_PATH",
            "HOUDINI_DSO_ERROR",
            "HOUDINI_TEMP_DIR",
            
            # Project/Scene context
            "HIP",
            "JOB",
            
            # Renderer Specific (Arnold/Redshift/Karma/Vray) - Add as needed
            "HTOA_PLUGIN_PATH",  # Arnold
            "HOUDINI_GL_TEXTURE_BUFFER_SIZE",
        }

        for key, value in os.environ.items():
            key_upper = key.upper()
            if key_upper.startswith("HAL") or key_upper in ALLOWED_HOUDINI_KEYS:
                job_info[f"EnvironmentKeyValue{env_index}"] = f"{key}={value}"
                env_index += 1
                count_added += 1
        
        logger.info(f"--- Environment Injection: Added {count_added} Houdini-safe variables ---")

        job_file = self._write_temp_file(job_info, ".job")
        plugin_file = self._write_temp_file(plugin_info, ".plugin")

        cmd = [self.deadline_bin, job_file, plugin_file]
        
        logger.info(f"Executing Deadline Command: {' '.join(cmd)}")
        
        result = None
        try:
            startupinfo = None
            if os.name == 'nt':
                startupinfo = subprocess.STARTUPINFO()
                startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW

            result = subprocess.run(cmd, capture_output=True, text=True, startupinfo=startupinfo)
        except Exception as e:
            self._cleanup(job_file, plugin_file)
            raise RuntimeError(f"Failed to execute deadlinecommand: {e}")

        # Cleanup temp files
        self._cleanup(job_file, plugin_file)

        if result.returncode != 0:
            raise RuntimeError(f"Deadline submission failed:\n{result.stderr}\n{result.stdout}")

        # Parse Job ID
        job_id = None
        for line in result.stdout.splitlines():
            if line.startswith("JobID="):
                job_id = line.split("=")[1].strip()
                break
        
        if not job_id:
            logger.warning(f"Could not explicitly parse JobID from output. Output was:\n{result.stdout}")
            return "Submission Successful (ID parsing failed)"
            
        return job_id

    def _cleanup(self, *files):
        for f in files:
            try:
                os.unlink(f)
            except OSError:
                pass

    @staticmethod
    def _write_temp_file(info_dict, suffix):
        """Writes a dictionary to a temporary file in 'Key=Value' format."""
        lines = []
        for k, v in info_dict.items():
            if isinstance(v, bool):
                v = str(v)
            if v is not None:
                lines.append(f"{k}={v}")
        
        text = "\n".join(lines)
        
        tmp = tempfile.NamedTemporaryFile(delete=False, suffix=suffix, mode='w', encoding='utf-8')
        tmp.write(text)
        tmp.close()
        return tmp.name

def deadline_submit(job_data, plugin_data):
    """
    Helper function to easily submit from external scripts.
    """
    submitter = DeadlineSubmitter()
    return submitter.submit(job_data, plugin_data)




# job_info = {
#     "Name": "My Houdini Job",
#     "Plugin": "Houdini",
#     "Frames": "1-100",
#     "Pool": "houdini_pool"
# }

# plugin_info = {
#     "SceneFile": r"C:\projects\shot_01.hip",
#     "OutputDriver": "/out/mantra_ipr", # The node path in Houdini
#     "Version": "19.5" # Optional, often detected automatically by the plugin
# }

# job_id = deadline_submit(job_info, plugin_info)
# print(f"Submitted Job: {job_id}")