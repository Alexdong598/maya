"""This Module is make Deadline Plugins deepened options function."""

# Import built-in modules
import logging
import os
import pprint

try:
    # Python 2 versions.
    from StringIO import StringIO
    from ConfigParser import RawConfigParser
except ImportError:
    from io import StringIO
    from configparser import RawConfigParser  # pylint: disable=import-error

# Import third-party modules
from addict import Dict  # pylint: disable=import-error
from hal_paths.paths import recursive_expandvars

# Import local modules
from deadline_submission_api.config import get_config
from deadline_submission_api.constants import JOB_PARAMETERS
from deadline_submission_api.constants import REPOSITORY_KEY
from deadline_submission_api.error import DeadlineSubmitAPIError


class ParameterBase(Dict):
    """Base class for Deadline parameters."""

    def __init__(self, plugin_name):
        """Initialize with plugin name to get the plugin's options.

        Args:
            plugin_name (str): Deadline plugin name.

        """
        super(ParameterBase, self).__init__()
        self._logger = logging.getLogger(__name__)
        self._plugin_name = plugin_name
        self._init()

    def _init(self):
        """You can overwrite it."""
        raise NotImplementedError

    @staticmethod
    def get_repository_path():
        """Get path to the current Deadline repository.

        Returns:
            str: Absolute path to deadline repository.

        """
        return get_config(REPOSITORY_KEY)

    def __getitem__(self, key):
        """Recursively expand environment variables in the given key.

        Args:
            key (str): The name of the script item config key.

        Returns:
            str: The original value with environment vars expanded.

        """
        value = super(ParameterBase, self).__getitem__(key)
        return (recursive_expandvars(value)
                if isinstance(value, basestring) else value)

    @staticmethod
    def list_to_dict(list_):
        """Convert list to dict.

        Args:
            list_ (list): Parameters name.

        Returns:
            dict: Parameters dict.

        """
        return {el: '' for el in list_}

    def __str__(self):
        """Print this object.

        Returns:
            str: A description of the current object.

        """
        return pprint.pformat(self)

    def make_submit_info(self):
        """Write Deadline specific key=value info.

        Returns:
            dict: Deadline info parameters.

        """
        return {
            key: (recursive_expandvars(value) or str(value)
                  if isinstance(value, basestring) else value)
            for key, value in self.items() if '_' not in key
        }

    def get_options_file(self):
        """Get values specified in plugin .options file.

        Returns:
            str: Absolute Deadline options file.

        """
        repo_path = self.get_repository_path()
        # Get deadline default plugin option file path.
        # //deadline/repository8/plugins
        plugins_dir = os.path.join(repo_path, 'plugins')
        # Get deadline custom plugin option file path.
        # //deadline/repository8/custom/plugins
        custom_plugins_dir = os.path.join(repo_path, 'custom', 'plugins')

        file_name = '{}.options'.format(self._plugin_name)

        options_file = os.path.join(custom_plugins_dir, self._plugin_name,
                                    file_name)

        if not os.path.isfile(options_file):
            options_file = os.path.join(plugins_dir, self._plugin_name,
                                        file_name)
        self._logger.debug('Find options file: %s', options_file)
        if not os.path.isfile(options_file):
            msg = 'Did not find a plugin named {}'.format(self._plugin_name)
            raise DeadlineSubmitAPIError(msg)
        return options_file

    def get_options_from_file(self, options_file):
        """Get dict values from Deadline options file.

        Args:
            options_file (str): Absolute Deadline options file path.

        Returns:
            dict: Dict values from Deadline options file.

        """
        required = []
        with open(options_file, 'rb') as temp_conf:
            conf = RawConfigParser()
            # Fix some option file have utf8 problem.
            content = temp_conf.read().decode('utf-8-sig').encode('utf8')
            conf.readfp(StringIO(content))
            # Add deadline plugin required options to default.
            for section in conf.sections():
                if conf.get(section, 'Required') == 'true':
                    required.append(section)
            _data = self.list_to_dict(required)
        return _data


class PluginParameters(ParameterBase):
    """Class to hold "Plugin Info" parameters.

    Values are read from <plugin_name>.options file from the
    Deadline repository. To locate a matching <plugin_name>.options
    file paths are searched in the following order:

        //deadline/repository8/custom/plugins
        //deadline/repository8/plugins

    """

    def _init(self):
        """Use values specified in plugin .options file."""
        options_file = self.get_options_file()
        data_ = self.get_options_from_file(options_file)
        self.update(data_)


class JobParameters(ParameterBase):
    """Class to hold "Job Info" parameters."""

    def _init(self):
        """Use defaults from JOB_PARAMETERS global dict."""
        self.update(JOB_PARAMETERS)
        self.Plugin = self._plugin_name  # pylint: disable=invalid-name
