"""The utils functions of the deadline submission api."""

# Import third-party modules
try:
    from Deadline.DeadlineConnect import DeadlineCon
except ImportError:
    # It's convenient for us to skip it in unit tests.
    DeadlineCon = None
from hal_paths.paths import to_platform_path

# Import local modules
from deadline_submission_api.config import get_config  # noqa: I100
from deadline_submission_api.constants import HOST_KEY  # noqa: I100
from deadline_submission_api.constants import PORT_KEY  # noqa: I100


def get_key_value_amount(parameter, keyword):
    """Get the Deadline Job Deadline environment key-value amount.

    Match keywords to get the total amount of attributes.
    .e.g.:
        ``EnvironmentKeyValue``,
        ``ExtraInfoKeyValue``,
        ``ExtraInfo``,
        etc.

    Args:
        parameter (deadline_submission_api.options.ParameterBase): The
            parameter instance.
        keyword (str): Name of Job parameters.

    Returns:
        int: The Job parameters key values total.

    """
    return len(get_parameters(parameter, keyword))


def get_parameters(parameter, keyword):
    """Get the Deadline Job Deadline parameters.

    Args:
        parameter (deadline_submission_api.options.ParameterBase): The
            parameter instance.
        keyword (str): Name of Job parameters.

    Returns:
        list of str: The Job parameters key values.

    """
    return [
        parameter[key] for key in parameter.keys() if key.startswith(keyword)
    ]


def set_parameter_key(parameter, key, value):
    """Add key and value to the deadline job parameter.

    Args:
        parameter (deadline_submission_api.options.ParameterBase): The
            Deadline parameter instance.
        key (str): The name of the Deadline parameter key.
            .e.g.:
                `EnvironmentKeyValue`,
                `ExtraInfoKeyValue`,
                `ExtraInfo` .
        value (:obj:`str` or :obj:`int` or :obj:`bool`): The value to
            assign to the Deadline parameter key-value.

    """
    index = get_key_value_amount(parameter, key)
    parameter['{}{}'.format(key, index)] = value


def get_deadline_connect():
    """Get the deadline connect instance.

    Returns:
        Deadline.DeadlineConnect.DeadlineCon: The connect instance fo Deadline.

    """
    return DeadlineCon(*map(get_config, [HOST_KEY, PORT_KEY]))


def convert_auxiliary_pathing(aux_file_paths, to_type="Windows"):
    """Check and or convert auxiliary file paths to their windows path.

    The deadline python api sends a path to the deadline webservice;
    this path needs to be accessible to the webservice - which runs on windows.
    Therefore, let's convert from linux to windows path before sending
    a job to deadline.

    Args:
        aux_file_paths (:obj: `list` of :obj:`str` or str): The list of full
            unix paths to convert or a single string path.
        to_type (str): Optional argument to determine which platform the new
            aux file should be mapped to. Default is "windows" since the
            webservice is currently in windows.

    Returns:
        new_aux_paths: (:obj: `list` of :obj:`str`): The list of converted
            unix paths.
    """
    # Let's ensure we output the same auxiliary file type passed
    # into the logic. The api can accept either:
    # - a single string file path
    # - a list of string file paths
    formatted_file_paths = list()
    files = aux_file_paths
    if not isinstance(aux_file_paths, list):
        files = [aux_file_paths]

    # We only want to convert when a linux file path is passed in.
    for aux_path in files:
        converted_path = aux_path
        # We only want to convert files that are Linux paths to Windows
        # due to the Deadline webservice being run on a Windows machine
        if aux_path.startswith('/mnt'):
            converted_path = to_platform_path(aux_path, "Windows")
        formatted_file_paths.append(converted_path)
    return formatted_file_paths
