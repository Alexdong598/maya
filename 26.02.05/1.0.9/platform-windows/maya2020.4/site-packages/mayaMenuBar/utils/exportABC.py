"""
Alembic export utility for Maya, using a MEL command call from Python
for maximum stability.

This script provides a primary function `export_abc` that can be used
for both animated sequences and static, single-frame exports.
"""
import os
import maya.cmds as cmds
import maya.mel as mel
import importlib
import sys
from ..compat import PY2

def export_abc(path, start_frame, end_frame):
    """
    Core function to export the current selection to an Alembic file.
    It builds and executes a raw MEL command for stability.

    To export a static model, pass the same value for start_frame and end_frame.

    Args:
        path (str): The full output file path.
        start_frame (int): The start frame of the export range.
        end_frame (int): The end frame of the export range.
    """
    # Ensure Alembic plugin is loaded
    if not cmds.pluginInfo("AbcExport", query=True, loaded=True):
        try:
            cmds.loadPlugin("AbcExport.mll")
        except RuntimeError as e:
            if PY2:
                cmds.error("Failed to load AbcExport plugin: {}".format(e))
            else:
                cmds.error(f"Failed to load AbcExport plugin: {e}")
            return

    # Get the current selection
    selected_nodes = cmds.ls(sl=True, long=True)
    if not selected_nodes:
        cmds.warning("Cannot export Alembic: No objects selected.")
        raise RuntimeError("No objects selected for Alembic export.")

    # Ensure the output directory exists
    output_dir = os.path.dirname(path)
    if not os.path.exists(output_dir):
        try:
            os.makedirs(output_dir)
        except OSError as e:
            if PY2:
                cmds.error("Could not create directory {}: {}".format(output_dir, e))
            else:
                cmds.error(f"Could not create directory {output_dir}: {e}")
            return

    # --- MEL Command Construction ---
    path = path.replace('\\', '/')
    if PY2:
        roots_arg = " ".join(["-root {}".format(node) for node in selected_nodes])
        job_arg_string = (
            "-frameRange {} {} ".format(start_frame, end_frame) +
            "-uvWrite " +
            "-writeColorSets " +
            "-writeUVSets " +
            "-dataFormat ogawa " +
            roots_arg + " " +
            "-file \\\"{}\\\"".format(path)  # Escape quotes for the file path in MEL
        )
    else:
        roots_arg = " ".join([f"-root {node}" for node in selected_nodes])
        job_arg_string = (
            f"-frameRange {start_frame} {end_frame} "
            f"-uvWrite "
            f"-writeColorSets "
            f"-writeUVSets "
            f"-dataFormat ogawa "
            f"{roots_arg} "
            f"-file \\\"{path}\\\""  # Escape quotes for the file path in MEL
        )
    if PY2:
        mel_command = 'AbcExport -j "{}";'.format(job_arg_string)
    else:
        mel_command = f'AbcExport -j "{job_arg_string}";'
    
    # --- Execute MEL Command ---
    if PY2:
        print("Executing MEL command: {}".format(mel_command))
    else:
        print(f"Executing MEL command: {mel_command}")
    try:
        mel.eval(mel_command)
        if PY2:
            success_message = "Successfully exported Alembic to: {}".format(path)
        else:
            success_message = f"Successfully exported Alembic to: {path}"
        cmds.inViewMessage(msg=success_message, pos="topLeft", fade=True, fadeStayTime=3000)
        print(success_message)
    except Exception as e:
        if PY2:
            cmds.error("Alembic export failed. See script editor for details. Error: {}".format(e))
        else:
            cmds.error(f"Alembic export failed. See script editor for details. Error: {e}")
        raise

def execute_with_dialog():
    """
    A helper function for standalone testing. It opens a dialog to let the user
    pick a path and exports the current timeline's animation range.
    """
    print("Executing animated Alembic export with dialog...")
    
    # Get frame range from the playback timeline.
    start_frame = cmds.playbackOptions(q=True, minTime=True)
    end_frame = cmds.playbackOptions(q=True, maxTime=True)

    # Open file dialog for the user to select a save path.
    file_path_raw = cmds.fileDialog2(
        fileFilter="Alembic (*.abc)",
        dialogStyle=2,
        fileMode=0,
        caption="Export Animated Alembic (MEL Method)"
    )

    if not file_path_raw:
        print("Alembic export cancelled by user.")
        return
    
    path = file_path_raw[0]
    
    # Call the core export function with the animation range.
    export_abc(path, start_frame, end_frame)


def get_command():
    """Returns the command implementation for standalone execution."""
    def _command():
        importlib.reload(sys.modules[__name__])
        execute_with_dialog()
    return _command

def execute():
    """
    Main entry point for running this script standalone to export an animation.
    """
    importlib.reload(sys.modules[__name__])
    cmd = get_command()
    cmd()
