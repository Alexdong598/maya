"""Create helper functions when unit testing.

The pytest plugin hooks do not need to be imported into any test code, it will
load automatically when running pytest.

References:
    https://docs.pytest.org/en/2.7.3/plugins.html?highlight=re

"""

# Import built-in modules
import os

# Import third-party modules
import pytest


@pytest.fixture()
def create_temp_plugin(repository_path):
    """Create local deadline temp repository."""
    def plugin(data):
        plugin_name = data['plugin_name']
        folder = repository_path.join('plugins')
        if not folder.exists():
            folder = repository_path.mkdir('plugins')
        plugin_folder = folder.mkdir(plugin_name)
        file_name = '{}.options'.format(plugin_name)
        options_file = plugin_folder.join(file_name)
        options_file.write(data['options'])
    return plugin


@pytest.fixture()
def setup_test_plugin(create_temp_plugin):
    """Set up a deadline plugin for test."""
    plugin_name = 'custom_plugin'
    options = ('[Version]\n'
               'Required=false\n'
               '[SceneFile]\n'
               'Required=false\n')
    test_data = {'plugin_name': plugin_name, 'options': options}
    create_temp_plugin(test_data)


@pytest.fixture(autouse=True)
def set_env(monkeypatch):
    """Set up the test envs."""
    mappings = {
        'HAL_AREA': 'shots:testproject_tst-0000/046/0010',
        'HAL_SHOT_ROOT': r'X:\testproject_tst-0000\046\0010',
        'REZ_USED_RESOLVE': 'test_package-1',
        'HAL_PROJECT': 'testproject_tst-0000',
        'TestUserName': 'test.user',
        'TestPluginName': 'custom_plugin'
    }
    for key, value in mappings.items():
        monkeypatch.setenv(key, value)


@pytest.fixture()
def repository_path(monkeypatch, tmpdir_factory):
    """Get the temp repository.

    Returns:
        str: Absolute file path of the temporary folder.

    """
    repo_path = tmpdir_factory.mktemp('deadline_')
    monkeypatch.setenv('_TEMP_REPO_PATH', str(repo_path))
    return repo_path


@pytest.fixture(autouse=True)
def mock_config(monkeypatch, repository_path):
    """Mock the configuration."""
    config_path = os.path.join(
        os.path.dirname(__file__),
        'config'
    )
    monkeypatch.setenv('HAL_CONFIG_PATH', config_path)
    return config_path


@pytest.fixture()
def deadline_connect(mocker):
    """Mock the deadline connect."""
    deadline_ = mocker.patch(
        'deadline_submission_api.utils.get_deadline_connect')
    submit_job = mocker.Mock(SubmitJob=mocker.Mock(return_value='failed'))
    deadline_.return_value = mocker.Mock(Jobs=submit_job)
    return deadline_
