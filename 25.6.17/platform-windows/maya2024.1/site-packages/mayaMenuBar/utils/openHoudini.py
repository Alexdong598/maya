import os,re
import subprocess
import sys

HAL_AREA = os.environ.get("HAL_AREA")
# HAL_TASK = os.environ.get("HAL_TASK")

afx_cmd = [
    "afx",
    "--area", HAL_AREA,
    "--task", 'shd',
    "run", "houdini"
]    

HAL_CONFIG_PATHS = os.environ.get("HAL_CONFIG_PATH", "").split(";")
HAL_ETC = os.environ.get("HAL_ETC", "")
candidates = []
for path in HAL_CONFIG_PATHS:
    if not path or path == HAL_ETC:
        continue
    try:
        if "houdini.hal" in os.listdir(path):
            candidates.append(path)
    except OSError:
        continue

selected_path = max(candidates, key=len) if candidates else None

if selected_path:
    file_path = os.path.join(selected_path, "houdini.hal")
    try:
        with open(file_path, 'r') as file:
            content = file.read()
            
            parts = content.split("packages:")
            if len(parts) > 1:
                packages_section = parts[1].strip()
            else:
                print("No 'packages:' section found in the file")
                
    except FileNotFoundError:
        print(f"Error: File not found at {file_path}")
    except Exception as e:
        print(f"Error processing file: {e}")
else:
    print("No valid houdini.hal files found")


clean_packages_list = []

for line in packages_section.splitlines():
    stripped_line = line.strip()
    if not stripped_line or stripped_line.startswith('#'):
        continue

    match = re.search(r'-\s*(.*)', stripped_line)
    if not match:
        continue
    
    package_name = match.group(1).strip()

    if ('!' in package_name or
            '"' in package_name or
            package_name.startswith('houdini-==')):
        continue
    clean_packages_list.append(package_name)

packages = []
for pkg in clean_packages_list:
    packages.extend(['+p', pkg])

insert_params = packages
run_index = afx_cmd.index("run")
afx_cmd[run_index:run_index] = insert_params

# print(afx_cmd)
try:
    if os.name == 'nt':  # Windows系统
        subprocess.Popen(["start", "/B"] + afx_cmd, shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    else:  # Linux/Mac系统
        subprocess.Popen(afx_cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
    print("Houdini已在后台启动")
except Exception as e:
    print(f"启动Houdini时出错: {e}")
    sys.exit(1)