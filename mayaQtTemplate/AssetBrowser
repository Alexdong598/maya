import sys
import os

HOST = "standalone"

try:
    import maya.cmds as cmds
    try:
        import maya.standalone
        try:
            maya.standalone.initialize(name='python')
        except:
            pass
    except ImportError:
        pass

    # NOW we can safely use cmds
    if cmds.about(batch=True):
        HOST = "standalone"
    else:
        from maya.app.general.mayaMixin import MayaQWidgetDockableMixin
        HOST = "maya"
        
except ImportError:
    pass

try:
    import hou
    HOST = "houdini"
except ImportError:
    pass

# Setup PySide2 Imports
from PySide2 import QtWidgets, QtCore, QtGui

# --- 2. DYNAMIC INHERITANCE ---
if HOST == "maya":
    BaseClass = MayaQWidgetDockableMixin
else:
    class BaseClass(object): pass

class AssetCardWidget(QtWidgets.QWidget):
    def __init__(self, name, price, date, image_path=None, parent=None):
        super(AssetCardWidget, self).__init__(parent)
        self.setFixedSize(180, 200) 
        
        # LOGIC STATE
        self.default_bg_color = "#444"
        self.drag_start_pos = QtCore.QPoint()
        
        # LAYOUT
        self.layout = QtWidgets.QVBoxLayout(self)
        self.layout.setContentsMargins(0,0,0,0)
        self.layout.setSpacing(0)
        
        # --- TOP: Image Container ---
        self.image_container = QtWidgets.QFrame()
        self.base_style = "border-top-left-radius: 4px; border-top-right-radius: 4px;"
        self.update_header_color(self.default_bg_color)
        
        self.overlay_layout = QtWidgets.QGridLayout(self.image_container)
        self.overlay_layout.setContentsMargins(5,5,5,5)
        
        # Price Tag
        self.price_lbl = QtWidgets.QLabel(price)
        self.price_lbl.setStyleSheet("""
            background-color: #8db600; color: white; font-weight: bold; 
            padding: 2px 6px; border-radius: 2px;
        """)
        self.price_lbl.setFixedHeight(20)
        self.overlay_layout.addWidget(self.price_lbl, 0, 1, QtCore.Qt.AlignRight | QtCore.Qt.AlignTop)
        self.overlay_layout.setRowStretch(1, 1) 

        # Center Image
        self.center_icon = QtWidgets.QLabel()
        self.center_icon.setAlignment(QtCore.Qt.AlignCenter)
        
        if image_path and os.path.exists(image_path):
            pixmap = QtGui.QPixmap(image_path)
            # Scale smoothly
            scaled = pixmap.scaled(150, 120, QtCore.Qt.KeepAspectRatio, QtCore.Qt.SmoothTransformation)
            self.center_icon.setPixmap(scaled)
        else:
            self.center_icon.setText("IMG")
            self.center_icon.setStyleSheet("color: #666; font-size: 20px; font-weight: bold;")
            
        self.overlay_layout.addWidget(self.center_icon, 1, 0, 1, 2, QtCore.Qt.AlignCenter)

        # --- BOTTOM: Info ---
        self.info_frame = QtWidgets.QFrame()
        self.info_frame.setFixedHeight(60)
        self.info_frame.setStyleSheet("background-color: #333; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px;")
        
        self.info_layout = QtWidgets.QVBoxLayout(self.info_frame)
        self.info_layout.setContentsMargins(8, 5, 8, 5)
        self.info_layout.setSpacing(2)
        
        self.lbl_name = QtWidgets.QLabel(name)
        self.lbl_name.setStyleSheet("color: white; font-weight: bold; font-size: 11px;")
        self.lbl_name.setWordWrap(True)
        
        self.lbl_date = QtWidgets.QLabel(date)
        self.lbl_date.setStyleSheet("color: #888; font-size: 10px;")
        
        self.info_layout.addWidget(self.lbl_name)
        self.info_layout.addWidget(self.lbl_date)
        self.info_layout.addStretch()

        self.layout.addWidget(self.image_container)
        self.layout.addWidget(self.info_frame)
        
        self.setStyleSheet("AssetCardWidget { background-color: transparent; } QFrame { border: none; }")

    def update_header_color(self, color):
        self.image_container.setStyleSheet(f"background-color: {color}; {self.base_style}")

    # --- EVENTS ---
    def enterEvent(self, event):
        super(AssetCardWidget, self).enterEvent(event)
        self.update_header_color("#555")

    def leaveEvent(self, event):
        super(AssetCardWidget, self).leaveEvent(event)
        self.update_header_color(self.default_bg_color)

    def mousePressEvent(self, event):
        if event.button() == QtCore.Qt.LeftButton:
            self.drag_start_pos = event.pos()
            self.update_header_color("#666") 
            print(f"Selected: {self.lbl_name.text()}")
        super(AssetCardWidget, self).mousePressEvent(event)

    def mouseReleaseEvent(self, event):
        self.update_header_color("#555")
        super(AssetCardWidget, self).mouseReleaseEvent(event)

    def mouseMoveEvent(self, event):
        if not (event.buttons() & QtCore.Qt.LeftButton): return
        distance = (event.pos() - self.drag_start_pos).manhattanLength()
        if distance < QtWidgets.QApplication.startDragDistance(): return

        drag = QtGui.QDrag(self)
        mime_data = QtCore.QMimeData()
        mime_data.setText(self.lbl_name.text())
        drag.setMimeData(mime_data)

        if self.center_icon.pixmap():
            thumbnail = self.center_icon.pixmap().scaled(60, 60, QtCore.Qt.KeepAspectRatio)
            drag.setPixmap(thumbnail)
            drag.setHotSpot(thumbnail.rect().center())

        drag.exec_(QtCore.Qt.CopyAction | QtCore.Qt.MoveAction)
        self.update_header_color(self.default_bg_color)


# -----------------------------------------------------------------------------
# 4. MAIN WINDOW (Universal)
# -----------------------------------------------------------------------------
class AssetBrowser(BaseClass, QtWidgets.QMainWindow):
    _instance = None

    def __init__(self, parent=None):
        # HOST PARENTING LOGIC
        if parent is None:
            if HOST == "houdini":
                parent = hou.qt.mainWindow()
                
        super(AssetBrowser, self).__init__(parent=parent)
        self.setWindowTitle(f"Asset Browser ({HOST.upper()})")
        self.resize(1100, 700) # Default Size
        
        # GLOBAL STYLESHEET
        self.setStyleSheet("""
            QMainWindow { background-color: #2b2b2b; }
            QWidget { font-family: Segoe UI, sans-serif; color: #ddd; }
            QSplitter::handle { background-color: #1a1a1a; width: 2px; }
            QTreeWidget { background-color: #222; border: none; }
            QTreeWidget::item { padding: 4px; }
            QTreeWidget::item:selected { background-color: #444; }
            QListWidget { background-color: #252525; border: none; }
            QLineEdit { background-color: #1a1a1a; border: 1px solid #444; border-radius: 10px; padding: 4px 10px; color: #eee; }
            /* Scrollbar styling */
            QScrollBar:vertical { background: #222; width: 10px; }
            QScrollBar::handle:vertical { background: #444; border-radius: 4px; }
        """)

        self.central_widget = QtWidgets.QWidget()
        self.setCentralWidget(self.central_widget)
        self.main_layout = QtWidgets.QVBoxLayout(self.central_widget)
        self.main_layout.setContentsMargins(0,0,0,0)

        # 1. HEADER
        self.build_header()

        # 2. SPLITTER
        self.splitter = QtWidgets.QSplitter(QtCore.Qt.Horizontal)
        self.main_layout.addWidget(self.splitter)

        # 3. PANELS
        self.build_left_panel()
        self.build_gallery_panel()
        self.build_inspector_panel()

        # Ratios
        self.splitter.setSizes([200, 600, 300])

    def build_header(self):
        header = QtWidgets.QFrame()
        header.setFixedHeight(45)
        header.setStyleSheet("background-color: #333; border-bottom: 1px solid #111;")
        layout = QtWidgets.QHBoxLayout(header)
        
        lbl_logo = QtWidgets.QLabel("ASSET LIBRARY")
        lbl_logo.setStyleSheet("font-weight: bold; font-size: 14px; color: white;")
        layout.addWidget(lbl_logo)
        
        layout.addStretch()
        
        self.search_bar = QtWidgets.QLineEdit()
        self.search_bar.setPlaceholderText("Search assets...")
        self.search_bar.setFixedWidth(250)
        layout.addWidget(self.search_bar)
        
        # Simulated Icons
        for icon_text in ["O", "F", "D"]: # Simple text placeholders for icons
            btn = QtWidgets.QPushButton(icon_text)
            btn.setFixedSize(30, 30)
            btn.setStyleSheet("""
                QPushButton { background-color: transparent; border: none; font-weight: bold; color: #888; }
                QPushButton:hover { background-color: #444; border-radius: 4px; color: white; }
            """)
            layout.addWidget(btn)

        self.main_layout.addWidget(header)

    def build_left_panel(self):
        panel = QtWidgets.QFrame()
        layout = QtWidgets.QVBoxLayout(panel)
        layout.setContentsMargins(0,0,0,0)
        
        title = QtWidgets.QLabel("  Locations")
        title.setStyleSheet("font-weight: bold; color: #aaa; padding: 5px;")
        layout.addWidget(title)

        self.tree = QtWidgets.QTreeWidget()
        self.tree.setHeaderHidden(True)
        
        categories = {
            "Autodesk SEEK": [],
            "Creative Market": ["Animals", "Architecture", "Characters", "Environment", "Food"],
            "Downloads": []
        }
        
        for root_name, subs in categories.items():
            root_item = QtWidgets.QTreeWidgetItem([root_name])
            root_item.setExpanded(True)
            self.tree.addTopLevelItem(root_item)
            for sub in subs:
                child = QtWidgets.QTreeWidgetItem([sub])
                root_item.addChild(child)
                if sub == "Animals": child.setSelected(True)
        
        layout.addWidget(self.tree)
        self.splitter.addWidget(panel)

    def build_gallery_panel(self):
        self.gallery_list = QtWidgets.QListWidget()
        self.gallery_list.setViewMode(QtWidgets.QListWidget.IconMode)
        self.gallery_list.setResizeMode(QtWidgets.QListWidget.Adjust) 
        self.gallery_list.setSpacing(10)
        self.gallery_list.setMovement(QtWidgets.QListWidget.Static)
        
        # --- PATH SETUP ---
        # Ensure this path is valid on your machine for the image to show!
        my_test_path = r"X:\_temp\yu.dong\openImageIO_v002.png" 

        assets = [
            ("PIG_Native.zip", "$49", "15-03-28"),
            ("PIGEON.fbx", "$15", "15-03-29"),
            ("RABBIT_Native", "$49", "15-03-28"),
            ("RHINO.fbx", "$15", "15-03-29"),
            ("HORSE_Anim", "$60", "15-04-01"),
            ("EAGLE_Fly", "$25", "15-04-02"),
        ]

        count = 0
        for name, price, date in assets:
            item = QtWidgets.QListWidgetItem()
            item.setSizeHint(QtCore.QSize(180, 200)) 
            self.gallery_list.addItem(item)
            
            # Pass image only to first item
            img = my_test_path if count == 0 else None
            card = AssetCardWidget(name, price, date, image_path=img)
            
            self.gallery_list.setItemWidget(item, card)
            count += 1

        self.splitter.addWidget(self.gallery_list)

    def build_inspector_panel(self):
        panel = QtWidgets.QFrame()
        panel.setStyleSheet("background-color: #2b2b2b;")
        layout = QtWidgets.QVBoxLayout(panel)
        layout.setContentsMargins(10, 10, 10, 10)
        
        # Preview
        preview_frame = QtWidgets.QFrame()
        preview_frame.setFixedHeight(200)
        preview_frame.setStyleSheet("background-color: #111; border: 1px solid #444;")
        p_layout = QtWidgets.QVBoxLayout(preview_frame)
        lbl_preview = QtWidgets.QLabel("3D VIEW")
        lbl_preview.setStyleSheet("color: #555; font-weight: bold;")
        lbl_preview.setAlignment(QtCore.Qt.AlignCenter)
        p_layout.addWidget(lbl_preview)
        layout.addWidget(preview_frame)
        
        # Buttons
        btn_buy = QtWidgets.QPushButton("Buy Now $49.00")
        btn_buy.setFixedHeight(40)
        btn_buy.setStyleSheet("background-color: #8db600; color: white; font-weight: bold; border-radius: 4px;")
        layout.addWidget(btn_buy)
        
        # Info
        layout.addSpacing(20)
        lbl_info = QtWidgets.QLabel("PIG with Native File")
        lbl_info.setStyleSheet("font-weight: bold; font-size: 14px; color: white;")
        layout.addWidget(lbl_info)
        
        # Details Grid
        info_grid = QtWidgets.QGridLayout()
        labels = [("Price:", "$49.00"), ("Date:", "Mar 28"), ("License:", "Standard"), ("Size:", "26 MB")]
        for i, (key, val) in enumerate(labels):
            info_grid.addWidget(QtWidgets.QLabel(key), i, 0)
            val_lbl = QtWidgets.QLabel(val)
            val_lbl.setAlignment(QtCore.Qt.AlignRight)
            info_grid.addWidget(val_lbl, i, 1)
            
        layout.addLayout(info_grid)
        layout.addStretch()
        self.splitter.addWidget(panel)


# -----------------------------------------------------------------------------
# 5. UNIVERSAL SHOW FUNCTION
# -----------------------------------------------------------------------------
def show_asset_browser():
    # --- MAYA ---
    if HOST == "maya":
        if cmds.workspaceControl("AssetBrowserWorkspaceControl", exists=True):
            cmds.deleteUI("AssetBrowserWorkspaceControl")
        if AssetBrowser._instance:
            try:
                AssetBrowser._instance.close()
                AssetBrowser._instance.deleteLater()
            except: pass
        
        AssetBrowser._instance = AssetBrowser()
        AssetBrowser._instance.show(dockable=True, width=1100, height=700, floating=True)

    # --- HOUDINI ---
    elif HOST == "houdini":
        if AssetBrowser._instance:
            AssetBrowser._instance.close()
        
        AssetBrowser._instance = AssetBrowser()
        # Explicitly set size for Houdini
        AssetBrowser._instance.resize(1100, 700)
        AssetBrowser._instance.show()

    # --- STANDALONE ---
    elif HOST == "standalone":
        app = QtWidgets.QApplication.instance()
        if not app: 
            app = QtWidgets.QApplication(sys.argv)
            
        win = AssetBrowser()
        win.resize(1100, 700)
        win.show()
        sys.exit(app.exec_())

# if __name__ == '__main__':
show_asset_browser()
