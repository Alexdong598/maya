import os,re
import subprocess
import importlib
import sys
from maya.cmds import warning

def open_houdini():
    """Launch Houdini with the current project settings"""
    try:
        def get_hal_file_path():
            HAL_CONFIG_PATHS = os.environ.get("HAL_CONFIG_PATH", "").split(";")
            HAL_ETC = os.environ.get("HAL_ETC", "")
            candidates = []
            for path in HAL_CONFIG_PATHS:
                if not path or path == HAL_ETC:
                    continue
                try:
                    if "houdini.hal" in os.listdir(path):
                        candidates.append(path)
                except OSError:
                    continue

            selected_path = max(candidates, key=len) if candidates else None
            return selected_path

        def get_packages_section(path):
            if path:
                file_path = os.path.join(path, "houdini.hal")
                try:
                    with open(file_path, 'r') as file:
                        content = file.read()
                        
                        parts = content.split("packages:")
                        if len(parts) > 1:
                            packages_section = parts[1].strip()
                            return packages_section
                        else:
                            print("No 'packages:' section found in the file")
                            
                except FileNotFoundError:
                    print(f"Error: File not found at {file_path}")
                except Exception as e:
                    print(f"Error processing file: {e}")
            else:
                print("No valid houdini.hal files found")
                return None
            
        selected_path = get_hal_file_path()
        packages_section = get_packages_section(selected_path)

        def get_clean_packages_list(packages_section):
            clean_packages_list = []
            for line in packages_section.splitlines():
                stripped_line = line.strip()
                if not stripped_line or stripped_line.startswith('#'):
                    continue

                match = re.search(r'-\s*(.*)', stripped_line)
                if not match:
                    continue
                
                package_name = match.group(1).strip()

                if ('!' in package_name or
                        '"' in package_name or
                        package_name.startswith('houdini-==')):
                    continue
                clean_packages_list.append(package_name)

            packages = []
            for pkg in clean_packages_list:
                packages.extend(['+p', pkg])
            return packages

        packages = get_clean_packages_list(packages_section)


        HAL_AREA = os.environ.get("HAL_AREA")
        afx_cmd = [
            "afx",
            "--area", HAL_AREA,
            "--task", 'shd',
            "run", "houdini"
        ]    

        insert_params = packages
        run_index = afx_cmd.index("run")
        afx_cmd[run_index:run_index] = insert_params

        try:
            if os.name == 'nt':  # Windows系统
                subprocess.Popen(["start", "/B"] + afx_cmd, shell=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            else:  # Linux/Mac系统
                subprocess.Popen(afx_cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
            print("Houdini已在后台启动")
        except Exception as e:
            print(f"启动Houdini时出错: {e}")
            sys.exit(1)
        
    except Exception as e:
        warning(f"Failed to launch Houdini: {str(e)}")

def get_command():
    """Return command implementation"""
    def _command():
        open_houdini()
    return _command

def execute():
    """Execute with reloading"""
    importlib.reload(sys.modules[__name__])
    cmd = get_command()
    cmd()

if __name__ == "__main__":
    execute()
