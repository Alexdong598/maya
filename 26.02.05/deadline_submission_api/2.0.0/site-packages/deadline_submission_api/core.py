"""This Module is Deadline submit API core function."""

# Import built-in modules
import logging
import platform

# Import third-party modules
from farm_environment import FarmEnvironment

# Import local modules
from deadline_submission_api import utils
from deadline_submission_api.error import DeadlineSubmitAPIError  # noqa: I100
from deadline_submission_api.options import JobParameters  # noqa: I100
from deadline_submission_api.options import PluginParameters  # noqa: I100


# pylint: disable=too-few-public-methods
class DeadlineSubmissionAPI(object):
    """Deadline submit class.

    All attribute naming just following deadline Job properties
    and plugin properties, more plugin properties detail you can check out.
    //deadline/repository8/custom/plugins/{plugin_name}/{plugin_name}.options
    //deadline/repository8/plugins/{plugin_name}/{plugin_name}.options

    """

    def __init__(self, plugin_name, aux_files=None, add_hal_env=True):
        """Init job and plugin parameters from deadline plugin .options file.

        Args:
            plugin_name (str): Deadline plugin name, plugin the job will use,
                `HAL_Nuke`,
                `HAL_Houdini`,
                `HAL_MayaCmd`, etc,
                searched order:
                `//deadline/repository8/custom/plugins`
                `//deadline/repository8/plugins`
            aux_files (list, optional): Absolute aux files path,
                plugin the job will use.
                Default is `None`.
            add_hal_env (bool, optional): Whether to add HAL environment
                variables to Deadline, default is `True`.

        """
        aux_files = aux_files or []
        self.job = JobParameters(plugin_name)
        self.plugin = PluginParameters(plugin_name)
        self._logger = logging.getLogger(__name__)
        self.aux_files = aux_files
        self.env = FarmEnvironment(False)
        self.hal_env = {}

        if add_hal_env:
            self.add_hal_env_to_deadline()

    def add_env_to_deadline(self, key, value):
        """Add Environment variable to Deadline.

        Args:
            key (str): Name of environment variable.
            value (:obj:`str` or :obj:`int` or :obj:`bool`): The value to
                assign to the Deadline environment key-value.

        """
        self.hal_env[key] = value
        value_ = '{}={}'.format(key, value)
        self.add_job_parameter_key('EnvironmentKeyValue', value_)

    def add_hal_env_to_deadline(self):
        """Add current session Environment variables to Deadline."""
        for env, value in sorted(self.env.items()):
            self.hal_env[env] = value
            self.add_env_to_deadline(env, value)

    def add_job_parameter_key(self, key, value):
        """Add a parameter key to Deadline.

        Args:
            key (str): The name of the Deadline parameter key.
                .e.g.:
                    `EnvironmentKeyValue`,
                    `ExtraInfoKeyValue`,
                    `ExtraInfo` .
            value (:obj:`str` or :obj:`int` or :obj:`bool`): The value to
                assign to the Deadline parameter key-value.

        """
        utils.set_parameter_key(self.job, key, value)

    def add_plugin_parameter_key(self, key, value):
        """Add a plugin parameter key to Deadline.

        Args:
            key (str): The name of the Deadline parameter key.
                .e.g.:
                    `EnvironmentKeyValue`,
                    `ExtraInfoKeyValue`,
                    `ExtraInfo` .
            value (:obj:`str` or :obj:`int` or :obj:`bool`): The value to
                assign to the Deadline parameter key-value.

        """
        utils.set_parameter_key(self.plugin, key, value)

    def submit(self, id_only=True):
        """Submit job to deadline and return job ID.

        Args:
            id_only (bool): Bool of only return job ID.

        Returns:
            dict or str: Deadline job ID.

        Raises:
            DeadlineSubmitAPIError: Parameter error, Deadline submit job
                failed.

        """
        job = self.job.make_submit_info()
        plugin = self.plugin.make_submit_info()
        deadline = utils.get_deadline_connect()
        # Let's check the file path(s) on the auxiliary files to ensure that
        # the webservice can find and access it.
        if self.aux_files is not None:
            self.aux_files = utils.convert_auxiliary_pathing(self.aux_files)
        returns_info = deadline.Jobs.SubmitJob(job, plugin, self.aux_files,
                                               id_only)
        if id_only and returns_info and isinstance(returns_info, dict):
            self._logger.info('Job ID: %s', returns_info['_id'])
            return returns_info['_id']
        elif isinstance(returns_info, dict):
            return returns_info
        elif isinstance(returns_info, str):
            # Raise Deadline submit failed errors.
            raise DeadlineSubmitAPIError(returns_info)
        return returns_info
