import maya.cmds as cmds
from pymel.core import *
from pymel.core.datatypes import *
import importlib
import sys
from ..compat import PY2

def check_uv_flip(selection=None):
    """Check for flipped UVs recursively on selected hierarchy"""
    flipped = []
    oStr = ''
    
    # Get selection or use provided
    sel = selection if selection else ls(sl=1, fl=1)
    if not sel:
        warning("Please select objects to check")
        return
        
    # Get all mesh descendants
    meshes = []
    for obj in sel:
        if obj.type() == 'transform':
            meshes.extend(listRelatives(obj, allDescendents=True, type='mesh', fullPath=True) or [])
    
    if not meshes:
        warning("No mesh objects found in selection")
        return
    
    for mesh in meshes:
        curUV = polyUVSet(mesh, q=1, cuv=1)
        
        for uv in polyUVSet(mesh, q=1, auv=1):
            polyUVSet(mesh, cuv=1, uvSet=uv)
            flf = []
            
            for f in ls("{}.f[*]".format(mesh) if PY2 else f"{mesh}.f[*]", fl=1):
                uvPos = polyEditUV(
                    [polyListComponentConversion(vf, fvf=1, toUV=1)[0] 
                     for vf in ls(polyListComponentConversion(f, tvf=1), fl=1)], 
                    q=1
                )
                uvAB = Vector([uvPos[2] - uvPos[0], uvPos[3] - uvPos[1]])
                uvBC = Vector([uvPos[4] - uvPos[2], uvPos[5] - uvPos[3]])
                
                if uvAB.cross(uvBC) * Vector([0, 0, 1]) <= 0:
                    flf.append(f)
            
            if flf:
                if PY2:
                    oStr += "{} has {} flipped faces in uvset {}\n".format(mesh, len(flf), uv)
                else:
                    oStr += f"{mesh} has {len(flf)} flipped faces in uvset {uv}\n"
                flipped.extend(flf)
        
        polyUVSet(mesh, cuv=1, uvSet=str(curUV))

    if not flipped:
        oStr = "No flipped UV faces found!"
    else:
        oStr = "Found flipped UV faces:\n" + oStr
        select(flipped, r=1)

    confirmDialog(button="Ok", m=oStr, t="UV Flipped Check")
    return flipped

def get_command():
    """Return command implementation"""
    def _command():
        check_uv_flip()
    return _command

def execute():
    """Execute with reloading"""
    importlib.reload(sys.modules[__name__])
    cmd = get_command()
    cmd()

if __name__ == "__main__":
    execute()
