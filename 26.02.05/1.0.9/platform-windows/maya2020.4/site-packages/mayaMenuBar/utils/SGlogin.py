import shotgun_api3
import os, re
import importlib
import sys
from ..compat import PY2

class ShotgunDataManager:
    def __init__(self):
        self.sg = shotgun_api3.Shotgun(base_url="https://aivfx.shotgrid.autodesk.com",
                          script_name="hal_roxy_templates_rw",
                          api_key="cstmibkrtcwqmaz4sjwtexG~s")
        
        # Handle environment variables safely
        self.HAL_PROJECT_SGID = os.environ.get('HAL_PROJECT_SGID')
        self.HAL_PROJECT = os.environ.get('HAL_PROJECT')
        self.HAL_PROJECT_ABBR = os.environ.get('HAL_PROJECT_ABBR')
        self.HAL_PROJECT_ROOT = os.environ.get('HAL_PROJECT_ROOT')


        self.HAL_AREA = os.environ.get('HAL_AREA')
        self.HAL_USER_ABBR = os.environ.get('HAL_USER_ABBR')
        self.HAL_USER_LOGIN = os.environ.get('HAL_USER_LOGIN')

        self.HAL_TREE = os.environ.get('HAL_TREE')
        if self.HAL_TREE == "shots":
            # From Sequence to Shot
            self.HAL_SEQUENCE = os.environ.get('HAL_SEQUENCE')
            self.HAL_SEQUENCE_SGID = os.environ.get('HAL_SEQUENCE_SGID')
            self.HAL_SEQUENCE_ROOT = os.environ.get('HAL_SEQUENCE_ROOT')

            self.HAL_SHOT = os.environ.get('HAL_SHOT')
            self.HAL_SHOT_SGID = os.environ.get('HAL_SHOT_SGID')
            self.HAL_SHOT_ROOT = os.environ.get('HAL_SHOT_ROOT')
            
        if self.HAL_TREE == "assets":
            # From Category to Asset(Category does not have ShotgunID configured)
            self.HAL_CATEGORY = os.environ.get('HAL_CATEGORY')
            self.HAL_CATEGORY_ROOT = os.environ.get('HAL_CATEGORY_ROOT')

            self.HAL_ASSET = os.environ.get('HAL_ASSET')
            self.HAL_ASSET_SGID = os.environ.get('HAL_ASSET_SGID')
            self.HAL_ASSET_ROOT = os.environ.get('HAL_ASSET_ROOT')

        # Get Task
        self.HAL_TASK = os.environ.get('HAL_TASK')
        self.HAL_TASK_TYPE = os.environ.get('HAL_TASK_TYPE')
        self.HAL_TASK_ROOT = os.environ.get('HAL_TASK_ROOT')
        self.HAL_TASK_SGID = os.environ.get('HAL_TASK_SGID')
        self.HAL_TASK_OUTPUT_ROOT = os.environ.get('HAL_TASK_OUTPUT_ROOT') # Y:/ Framestone Root
        self.HAL_TASK_ROOT = os.environ.get('HAL_TASK_ROOT') # X:/ Project Root

        self.data_store = {}
        
    def getSGData(self, entity_type, entity_id, fields=None):
        """Store and retrieve Shotgun entity data in a dictionary cache"""
        # Create unique cache key
        if PY2:
            cache_key = "{}_{}".format(entity_type, entity_id)
        else:
            cache_key = f"{entity_type}_{entity_id}"
        
        # Fetch data if not cached
        if cache_key not in self.data_store:
            # Default fields if not specified
            if fields is None:
                fields = ["code", "sg_head_in", "sg_tail_out", "sg_cut_in", "sg_cut_out"]
            
            # Fetch data from Shotgun
            entity_data = self.sg.find_one(
                entity_type,
                [["id", "is", entity_id]],
                fields=fields
            )
            
            # Store in cache
            self.data_store[cache_key] = entity_data or {}
        
        return self.data_store[cache_key], self.HAL_PROJECT_SGID, self.HAL_SHOT_SGID

    def upload_file(self, entity_type, entity_id, path, field_name=None, display_name=None, tag_list=None):
        try:
            return self.sg.upload(
                entity_type,
                entity_id,
                path,
                field_name=field_name,
                display_name=display_name,
                tag_list=tag_list
            )
        except Exception as e:
            if PY2:
                print("Failed to upload file: {}".format(e))
            else:
                print(f"Failed to upload file: {e}")
            raise

    def upload_thumbnail(self, entity_type, entity_id, path, **kwargs):
        try:
            return self.sg.upload_thumbnail(
                entity_type,
                entity_id,
                path,
                **kwargs
            )
        except Exception as e:
            print(f"Failed to upload thumbnail: {e}")
            raise

    def upload_filmstrip_thumbnail(self, entity_type, entity_id, path, **kwargs):
        try:
            return self.sg.upload_filmstrip_thumbnail(
                entity_type,
                entity_id,
                path,
                **kwargs
            )
        except Exception as e:
            print(f"Failed to upload filmstrip thumbnail: {e}")
            raise

    def SG_Find_Version(self):
        filters = [] 
        parent_entity_type = None
        parent_entity_id = None

        if self.HAL_TREE == "shots":
            parent_entity_type = 'Shot'
            parent_entity_id = int(self.HAL_SHOT_SGID)
            self.HAL_CONTENT = f"{self.HAL_SEQUENCE}_{self.HAL_SHOT}_{self.HAL_TASK}"
        elif self.HAL_TREE == "assets":
            parent_entity_type = 'Asset'
            parent_entity_id = int(self.HAL_ASSET_SGID)
            self.HAL_CONTENT = f"{self.HAL_ASSET}_{self.HAL_TASK}"
        else:
            raise ValueError("HAL_TREE must be 'shots' or 'assets'.")

        task_filters = [
            ['project', 'is', {'type': 'Project', 'id': int(self.HAL_PROJECT_SGID)}],
            ['entity', 'is', {'type': parent_entity_type, 'id': parent_entity_id}],
            ['content', 'is', self.HAL_CONTENT] 
        ]

        self.task = self.sg.find_one('Task', task_filters, fields=['id', 'content', 'entity'])
        
        if not self.task:
            if PY2:
                raise ValueError("No Task found with content '{}' for {} ID {} in Project ID {}".format(self.HAL_CONTENT, parent_entity_type, parent_entity_id, self.HAL_PROJECT_SGID))
            else:
                raise ValueError(f"No Task found with content '{self.HAL_CONTENT}' for {parent_entity_type} ID {parent_entity_id} in Project ID {self.HAL_PROJECT_SGID}")

        if PY2:
            print("Found Task: {} (ID: {}) linked to {} ID {}".format(self.task['content'], self.task['id'], self.task['entity']['type'], self.task['entity']['id']))
        else:
            print(f"Found Task: {self.task['content']} (ID: {self.task['id']}) linked to {self.task['entity']['type']} ID {self.task['entity']['id']}")
        
        version_filters = [
            ['project', 'is', {'type': 'Project', 'id': int(self.HAL_PROJECT_SGID)}],
            ['entity', 'is', {'type': parent_entity_type, 'id': parent_entity_id}], 
            ['sg_task', 'is', self.task] 
        ]
        
        # Use sg.find() to get all matching versions
        all_versions = self.sg.find('Version', 
                                    version_filters, 
                                    fields=['code', 'description', 'sg_status_list', 'sg_path_to_frames', 'created_at', 'image'],
                                    order=[{'field_name': 'created_at', 'direction': 'desc'}]
                                    )
        
        versionCodes = []
        version_numbers = []
        
        if all_versions:
            if PY2:
                print("\nFound {} Versions linked to Task '{}':".format(len(all_versions), self.task['content']))
            else:
                print(f"\nFound {len(all_versions)} Versions linked to Task '{self.task['content']}':")
            
            for version in all_versions:
                versionCodes.append(version['code'])
                version_str = version['code']
                version_match = re.search(r'_v(\d{3,})_', version_str)
                if not version_match:
                    version_match = re.search(r'_v(\d{3,})$', version_str)
                
                if version_match:
                    version_numbers.append(int(version_match.group(1)))
                else:
                    if PY2:
                        print("Warning: Could not parse version number from: {}".format(version_str))
                    else:
                        print(f"Warning: Could not parse version number from: {version_str}")

        # --- MODIFICATION START: This block is updated for correctness ---
        if version_numbers:
            # Find the next version number from the list of all existing versions
            max_version = max(version_numbers)
            next_version = max_version + 1
        else:
            # If no versions exist or none could be parsed, start at 1
            if PY2:
                print("No previous versions found for this task. Starting with v001.")
            else:
                print(f"No previous versions found for this task. Starting with v001.")
            next_version = 1
            
        # Always construct the name from scratch using environment variables.
        # This ensures consistency and prevents carrying over old artist names.
        base_name = self.HAL_CONTENT
        highestVersionCode = f"{base_name}_v{next_version:03d}_{self.HAL_USER_ABBR}"
        # --- MODIFICATION END ---
        
        versionCodesNum = len(versionCodes)
        if PY2:
            print("The new version name is: {}".format(highestVersionCode))
        else:
            print(f"The new version name is: {highestVersionCode}")

        return versionCodes, highestVersionCode, versionCodesNum

    def Create_SG_Version(self, thumbnail_path, submit_path=None, first_frame=None, last_frame=None):
        """Create a Shotgun Version with the given thumbnail path and optional submit path"""
        highestVersion = self.SG_Find_Version()[1]
        if PY2:
            data = {
                "project": {"type": "Project", "name": self.HAL_PROJECT, "id": int(self.HAL_PROJECT_SGID)},
                "code": "{}".format(highestVersion),
                "sg_status_list": "ip",
                "image": thumbnail_path,
                "sg_task": self.task,
                "sg_path_to_geometry": submit_path,
                "sg_first_frame": first_frame,
                "sg_last_frame": last_frame
            }
        else:
            data = {
                "project": {"type": "Project", "name": self.HAL_PROJECT, "id": int(self.HAL_PROJECT_SGID)},
                "code": f"{highestVersion}",
                "sg_status_list": "ip",
                "image": thumbnail_path,
                "sg_task": self.task,
                "sg_path_to_geometry": submit_path,
                "sg_first_frame": first_frame,
                "sg_last_frame": last_frame
            }
        
        # Add entity specific data
        if self.HAL_TREE == "assets":
            data["entity"] = {"type": "Asset", "id": int(self.HAL_ASSET_SGID)}
        elif self.HAL_TREE == "shots":
            data["entity"] = {"type": "Shot", "id": int(self.HAL_SHOT_SGID)}
            
        # First create the version
        created_version = self.sg.create('Version', data)
        
        # The commented-out code below for uploading/linking files remains unchanged
        # ...
            
        return created_version

def get_command():
    """Return command implementation"""
    def _command():
        """Create new ShotgunDataManager instance"""
        global sg_manager
        try:
            if 'sg_manager' in globals():
                print("Updating existing ShotgunDataManager instance")
            sg_manager = ShotgunDataManager()
            
            # Update environment variables
            sg_manager.__init__()
            
            print("ShotgunDataManager successfully created")
            return sg_manager
        except Exception as e:
            if PY2:
                print("Error creating ShotgunDataManager: {}".format(str(e)))
            else:
                print(f"Error creating ShotgunDataManager: {str(e)}")
            raise

    # Create initial instance
    sg_manager = ShotgunDataManager()
    return _command

def execute():
    """Execute command"""
    cmd = get_command()
    cmd()

if __name__ == "__main__":
    execute()



# thumbnail_path = "Y:/pipelinernd_rnd-0192/_library/assets/vehicles/veh_benz/renders/rig/v045/fullres/rnd_veh_benz_rig_v045_yud.1002.png"
# sg_manager = ShotgunDataManager()
# sg_manager.Create_SG_Version(thumbnail_path)


# # Instance ShotgunDataManager() to get variables(do not delete!)
# sg_manager = ShotgunDataManager()
# HAL_PROJECT_SGID = sg_manager.HAL_PROJECT_SGID
# HAL_SHOTID = sg_manager.HAL_SHOTID

# cut_in = sg_manager.getSGData("Shot", HAL_SHOTID)[0].get('sg_cut_in', 'Not set')
# cut_out = sg_manager.getSGData("Shot", HAL_SHOTID)[0].get('sg_cut_out', 'Not set')
# print(f"Cut In: {cut_in}")
# print(f"Cut Out: {cut_out}")
