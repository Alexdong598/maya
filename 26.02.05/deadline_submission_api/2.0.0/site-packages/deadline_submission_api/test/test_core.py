"""Test for the deadline_submission_api.core functions."""

# Import local modules
from deadline_submission_api.core import DeadlineSubmissionAPI
from deadline_submission_api.core import DeadlineSubmitAPIError

# Import third-party module
import pytest


@pytest.mark.usefixtures('setup_test_plugin')
def test_add_env_to_deadline():
    """Test add environment variable key and value to Deadline."""
    submit = DeadlineSubmissionAPI(plugin_name='custom_plugin',
                                   add_hal_env=False)
    submit.add_env_to_deadline('test_key', 'test_value')
    assert submit.job.EnvironmentKeyValue0 == 'test_key=test_value'


@pytest.mark.usefixtures('setup_test_plugin')
def test_add_hal_env_to_deadline():
    """Test add hal environment variable key and value to Deadline."""
    submit = DeadlineSubmissionAPI(plugin_name='custom_plugin')
    area = 'shots:testproject_tst-0000/046/0010'
    assert submit.hal_env['HAL_AREA'] == area
    assert submit.hal_env['HAL_PROJECT'] == 'testproject_tst-0000'


@pytest.mark.usefixtures('setup_test_plugin')
def test_add_farm_environment_variables():
    """Ensure we add the environment variables from farm_environment."""
    submit = DeadlineSubmissionAPI(plugin_name='custom_plugin')
    assert submit.hal_env['HAL_NO_VALIDATION'] == True
    assert submit.hal_env['FOOBAR'] == 'foobar'


@pytest.mark.usefixtures('setup_test_plugin', 'deadline_connect')
def test_submit_to_deadline_failed():
    """Test the submit job failed we can catch the error."""
    submit = DeadlineSubmissionAPI(plugin_name='custom_plugin')
    with pytest.raises(DeadlineSubmitAPIError):
        assert submit.submit()


@pytest.mark.usefixtures('setup_test_plugin')
def test_submit_to_deadline(mocker, deadline_connect):
    """Test submit the job to Deadline."""
    data = {'_id': '1234', 'message': 'ok!'}
    submit_job = mocker.Mock(SubmitJob=mocker.Mock(return_value=data))
    deadline_connect.return_value = mocker.Mock(Jobs=submit_job)
    submit = DeadlineSubmissionAPI(plugin_name='custom_plugin')
    assert submit.submit() == '1234'
    assert submit.submit(False) == data
